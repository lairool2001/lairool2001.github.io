<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta http-equiv="content-language" content="zh-tw">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="js.cookie.min.js"></script>
    <link rel="Stylesheet" type="text/css" href="css/jPicker-1.1.6.min.css" />
    <link rel="Stylesheet" type="text/css" href="jPicker.css" />
    <script src="jpicker-1.1.6.min.js" type="text/javascript"></script>
    <title id="text10">圖型編輯器</title>
    <style type="text/css">
        #div_left {
            width: 300px;
            min-height: 90vh;
            background-color: antiquewhite;
            float: left;
        }

        #div_right {
            padding: 0px;
            margin: 0px;
            float: left;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -o-user-select: none;
        }

        #t1 {
            margin: 0px;
            padding: 0px;
            min-width: 200px;
            height: 30px;
        }

        #t2 {
            margin: 0px;
            padding: 0px;
            min-width: 200px;
            height: 80px;
        }

        #searchText {
            min-width: 200px;
            height: 20px;
        }

        #svg1 {
            background-color: aquamarine;
            border: 1px double black;
        }

        .rect1_text {
            text-anchor: middle;
            font-size: 20px;
            font-family: "Microsoft JhengHei";
        }

        .box {
            border: 2px dotted gray;
            width: auto;
            max-width: 230px;
            padding: 5px;
            margin: 5px;
        }

        .infoBox {
            max-width: 250px;
            min-width: 250px;
            border-left: 1px dashed black;
            border-right: 1px dashed black;
            text-align: center;
        }

        .ColorPick {
            width: 50px;
        }

        #myNumber {
            width: 50px;
        }

    </style>
</head>

<body onkeydown="body_onkeydown(event);" onkeyup="body_onkeyup(event);">
    <div id="div_left">
        <audio id="lineAudio" src="sound/18V_Cordless_Drill_Switch.mp3"></audio>
        <audio id="deletaAudio" src="sound/Air_Woosh_Underwater.mp3"></audio>
        <audio id="createAudio" src="sound/Beep_Short.mp3"></audio>
        <div class="box">
            <span id="text1">左鍵點擊方塊可以設定名稱與資料，右鍵分別點擊方塊連線，DEL刪除方塊或連線，C創造方塊，WASD可移動畫布，右鍵也可拖拉畫布。</span>
            <br />
            <br />
            <button onclick="create_onclick(this,event);"><span id="text8">在中央創造方塊</span></button>
        </div>
        <div class="box">
            <span id="text2">線段粗細(px):</span>
            <input type="number" id="myNumber" oninput="number_onInput(this,event);" defaultValue="2" value="2" min="1" max="20">
            <br />
            <span id="text11">線條顏色:</span><input class="ColorPick" type="text" id="color4" value="000000" /><br />
            <span id="text12">外框顏色:</span><input class="ColorPick" type="text" id="color1" value="000000" /><br />
            <span id="text13">方塊顏色:</span><input class="ColorPick" type="text" id="color2" value="FF0000" /><br />
            <span id="text14">文字顏色:</span><input class="ColorPick" type="text" id="color3" value="000000" />
        </div>
        <div class="infoBox">
            <span id="info"></span>
        </div>
        <div class="box">
            <span id="text3">[F]搜尋:</span>
            <br />
            <textarea id="searchText" onfocus="searchOnInput(this,event);" oninput=" searchOnInput(this,event);"></textarea>
        </div>
        <div class="box">
            <span id="text4">[F2]方塊名稱:</span><span id="text15">[x1] 獨立</span>
            <br />
            <textarea id="t1" oninput="t1_OnInput();"></textarea>
            <br />
            <span id="text5">[F3]方塊資料:</span>
            <textarea id="t2"></textarea>
        </div>
        <div class="box">
            <span id="text6">讀取檔案:</span>
            <br />
            <input type="file" id="file1" onchange="onChange(event);"></input>
            <br />
            <button onclick="button_LoadCookie(this,event)" id="button_LoadCookieElement">讀取本地上一次進度</button>
        </div>
        <div class="box">
            <span id="text9">存檔名稱:</span>
            <br />
            <textarea id="t3">圖形連線</textarea>
            <button onclick="save_onclick(this,event);" id="button1">[Q]儲存完整文字資料</button>
            <button onclick="save2_onclick(this,event);" id="button2">儲存完整.svg檔</button>
            <button onclick="button_SaveCookie(this,event)" id="button_SaveCookieElement">儲存進度到本地</button>
        </div>
        <div class="box">
            <input type="checkbox" checked id="soundCheckBox"><span id="text7">音效</span></input>
        </div>
    </div>
    <div id="div_right" onContextMenu="return false">
    </div>
    <script>
        $.fn.jPicker.defaults.images.clientPath = 'images/';
        let setting = {
            window: {
                expandable: true,
                position: {
                    x: 'screenCenter', // acceptable values "left", "center", "right",
                    // "screenCenter", or relative px value
                    y: '250px', // acceptable values "top", "bottom", "center", or relative px
                    // value
                }
            },
        };
        let change = function(color, context) {
            //決定顏色
            //stroke="black" stroke-width="2" fill="red"
            console.log(context);
            var all = color.val('all');
            if (previous_select_rect != null) {
                previous_select_rect.setAttributeNS(null, 'stroke', all && '#' + all.hex || 'transparent');
            }

        };
        c1 = $('#color1').jPicker(setting,
            change, change, change
        )
        console.log(c1[0].value);

        change = function(color, context) {
            //決定顏色
            //stroke="black" stroke-width="2" fill="red"
            console.log(context);
            var all = color.val('all');
            if (previous_select_rect != null) {
                previous_select_rect.setAttributeNS(null, 'fill', all && '#' + all.hex || 'transparent');
            }

        };
        c2 = $('#color2').jPicker(setting,
            change, change, change
        )
        //console.log(c2[0].value);

        change = function(color, context) {
            console.log(context);
            var all = color.val('all');
            if (previous_select_text != null) {
                previous_select_text.setAttributeNS(null, 'fill', all && '#' + all.hex || 'transparent');
            }

        };
        c3 = $('#color3').jPicker(setting,
            change, change, change
        )

        change = function(color, context) {
            console.log(context);
            var all = color.val('all');
            if (select_line != null) {
                console.log("s");
                select_line.setAttributeNS(null, 'stroke', all && '#' + all.hex || 'transparent');
            }

        };
        c4 = $('#color4').jPicker(setting,
            change, change, change
        )

        ini();

        function ini() {
            div_right.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" version="1.1" id="svg1" width="900" height="800" onmousedown="svg_onMouseDown(event)" viewBox="0 0 900 800" onMouseUp="onMouseUp(event);"></svg>`;
            previous_select_rect = null;
            previous_select_text = null;
            drag = false;
            select_rect = null;
            select_text = null;
            connect1_rect = null;
            connect1_text = null;
            connect2_rect = null;
            connect2_text = null;
            select_line = null;
            flow_id_block = 0;
            flow_id_line = 0;
            dx = dy = 0;
            blockz = [];
            blockById = {};
            connect = 0;
            ab = {};
            saveLoadIndex = 0;
            //start lang
            lang = (navigator.language || navigator.browserLanguage).toLowerCase();
            //lang = "en-us";
            console.log(lang);
            svg1.onmousemove = on_mouse_move;
            //svg1.onmousedown = on_mouse_down;
            svg1.addEventListener('mousedown', on_mouse_down, true);
            okToBodyKeydown = true
        }
        console.log(svg1.viewBox);
        addABlock();
        //addABlock();
        function button_LoadCookie(button, event) {
            console.log(document.cookie);
            //$.cookie.json = true;
            //text = $.cookie("all-data");
            //text = Cookies.get('all-data');
            text = localStorage.getItem("all-data")
            console.log(text)
            //text = getCookie("data");
            //text = getCookie("all-data");
            try {
                var savez = JSON.parse(text);
                var save = savez[saveLoadIndex];
                console.log(save);

                ini();
                setDataByData(save);
                svg1.onmousemove = on_mouse_move;
                check_blockById();
                console.log("load completed");
                if (blockz != null) {

                    showInfoAlphaDown("讀取檔案成功");
                } else {
                    ini();
                    showInfoAlphaDown("讀取檔案錯誤！初始化畫布。");
                }
            } catch {
                ini();
                showInfoAlphaDown("讀取檔案錯誤！初始化畫布。");
            }
        }

        function button_SaveCookie(button, event) {
            var data = getWholeData();
            console.log(data);
            var dataz = [];
            dataz[saveLoadIndex] = data;
            localStorage.setItem("all-data", JSON.stringify(dataz))
            showInfoAlphaDown("儲存檔案成功");
        }

        function getWholeData() {
            var data = {};
            data.flow_id_block = flow_id_block;
            data.flow_id_line = flow_id_line;
            data.ab = ab;
            data.blockById = blockById;
            data.version = 2;
            data.innerHTML = div_right.innerHTML;
            return data;
        }

        function t1_UpdateAndSearchAlone() {
            console.log("t1_OnInput");
            s = t1.value;
            console.log(s);
            findCount = 0;
            console.log(blockz);
            for (let i = 0; i < blockz.length; i++) {
                block = blockz[i];
                var name = document.getElementById(block.textId).innerHTML;
                console.log(i + ":" + name);
                if (name == s) {
                    findCount += 1;
                }
            }
            console.log(findCount);
            if (findCount == 1) {
                text15.style.color = "blue"
                text15.innerHTML = "[x1] 獨立";
            } else if (findCount == 0) {
                text15.style.color = "gray"
                text15.innerHTML = "[x0] 無";
            } else {
                text15.style.color = "red"
                text15.innerHTML = "[xN] 複數";
            }
            if (translate != null) {
                text15.innerHTML = translate[text15.innerHTML];
            }
        }

        setTextUponLanguae();

        function number_onInput(number, event) {
            //console.log("number_onInput");
            if (select_line != null) {
                select_line.setAttributeNS(null, 'stroke-width', number.value)
            }
        }
        /*翻譯 lang set*/
        function setTextUponLanguae(name) {
            database = {};
            translate = null;
            if (lang.includes("zh")) {
                //use default
            } else {
                text1.innerHTML = "Letft click block to set name or detail. Right click 2 block to connect. Press del to delete block or line. Press C to create block. WASD can move the canvas.Right mouse button hold can also move the canvas.";
                text2.innerHTML = "Line stroke width(px):"
                text3.innerHTML = "[F]Search:"
                text4.innerHTML = "[F2]Block name:"
                text5.innerHTML = "[F3]Block detail:"
                text6.innerHTML = "Load file:"
                text7.innerHTML = "Play Sound"
                text8.innerHTML = "Create block at center"
                text9.innerHTML = "Save file Name:"
                text10.innerHTML = "Graph Editor"
                text11.innerHTML = "Connect line:"
                text12.innerHTML = "Block outer frame:"
                text13.innerHTML = "Block background:"
                text14.innerHTML = "Word color:"
                t3.value = "Graph"
                button1.innerHTML = "Save data text"
                button2.innerHTML = "Save .svg"
                button_LoadCookieElement.innerHTML = "Load local storage"
                button_SaveCookieElement.innerHTML = "[Q]Save local storage"

                translate = {};
                translate["找到完全相同文字的方塊"] = "Found the exact same block of text."
                translate["找到包含文字的方塊"] = "Found the block containing the text."
                translate["在所有方塊中找不到文字"] = "No found."
                translate["創造方塊並放在鼠標位置"] = "Created the block and set at cursor position."
                translate["刪除方塊"] = "Deleted the block."
                translate["更新連線"] = "Updated the line"
                translate["刪除連線"] = "Deleted the line"
                translate["選取畫布"] = "Selected the canvas"
                translate["創造方塊並放在視圖中間"] = "Created the block and set at middle of view box."
                translate["選取直線"] = "Selected the line."
                translate["拖拉方塊"] = "Dragging the block."
                translate["移動畫布"] = "Moving the view box."
                translate["設定連線起點"] = "Set the start of line."
                translate["完成連線"] = "Completed the connection."
                translate["選取方塊"] = "Selected the block."
                translate["儲存檔案成功"] = "The file was saved successfully."
                translate["讀取檔案成功"] = "The file was loaded successfully."
                translate["讀取檔案錯誤！初始化畫布。"] = "Loading file error! Initialized the canvas."
                translate["取消連線"] = "Cancel connect."
                translate["取消選取方塊"] = "Deselected block";
                translate["[x1] 獨立"] = "[x1] alone";
                translate["[x0] 無"] = "[x2] void";
                translate["[xN] 複數"] = "[xN] multiple";
            }
        }

        function body_onkeyup(event) {
            okToBodyKeydown = true
        }

        function searchOnInput(search, event) {
            console.log('a');
            s = searchText.value;
            find = false;
            console.log(blockz);
            for (let i = 0; i < blockz.length; i++) {
                block = blockz[i];
                console.log(block.textId);
                console.log(document.getElementById(block.textId))
                var name = document.getElementById(block.textId).innerHTML;
                console.log(name);
                if (name == s) {
                    find = true;
                    break;
                }
            }
            if (find) {
                console.log('find same');
                showInfoAlphaDown("找到完全相同文字的方塊")
                lookAtBlockAndSelctIt(block)
                return;
            }
            for (let i = 0; i < blockz.length; i++) {
                block = blockz[i];
                var name = document.getElementById(block.textId).innerHTML;
                console.log(name);
                if (name.includes(s)) {
                    find = true;
                    break;
                }
            }
            if (find) {
                console.log('find contain');
                showInfoAlphaDown("找到包含文字的方塊")
                lookAtBlockAndSelctIt(block)
                return;
            }
            if (!find) {
                console.log('not find');
                showInfoAlphaDown("在所有方塊中找不到文字")
                return;
            }
        }

        function lookAtBlockAndSelctIt(block) {
            viewBox = svg1.viewBox;
            console.log(viewBox);
            rect = document.getElementById(block.rectId);
            seletctBlockAndSetTextAreaValueAndSync(block);
            console.log(rect.x);
            x = rect.x.animVal.value - svg1.viewBox.animVal.width / 2 + rect.width.animVal.value / 2;
            y = rect.y.animVal.value - svg1.viewBox.animVal.height / 2 + rect.height.animVal.value / 2;
            viewBox = `${x} ${y} ${svg1.viewBox.animVal.width} ${svg1.viewBox.animVal.height}`;
            //rect.setAttributeNS(null, 'x', svg1.viewBox.animVal.x - svg1.viewBox.animVal.width / 2);
            //rect.setAttributeNS(null, 'y', svg1.viewBox.animVal.x - svg1.viewBox.animVal.height / 2);
            svg1.setAttributeNS(null, "viewBox", viewBox);
        }

        check_blockById();

        function check_blockById() {
            for (i = 0; i < blockz.length; i++) {
                var a = document.getElementById(`rect` + i);
                if (a == null) {
                    console.log("null:deleted");
                } else {
                    console.log(blockById[a.id]);
                }
            }
        }

        function playSound(a) {
            if (soundCheckBox.checked) {
                a.currentTime = 0;
                a.play();
            }
        }

        function save2_onclick(button, event) {
            //svgToPng(svg1, 900, 800);
            //console.log(png);
            //console.log(svg1);
            exportSVG(svg1);
            //saveSvgAsPng(svg1, "diagram.png");
        }

        function body_onkeydown(event) {
            if (okToBodyKeydown) {
                //可按一次
            } else {
                return;
            }
            if (isFocueOnLeft()) {
                return;
            }
            var power = 10;
            //console.log(svg1.viewBox);
            console.log(event.keyCode);
            //console.log(event);

            xMin = svg1.viewBox.animVal.x;
            yMin = svg1.viewBox.animVal.y;
            width = svg1.viewBox.animVal.width;
            height = svg1.viewBox.animVal.height;

            event.cancelBubble = true;
            event.preventDefault();
            //keyboard fast
            switch (event.keyCode) {
                case 70:
                    //f
                    searchText.focus();
                    searchText.select();
                    break;
                case 81:
                    //Q
                    button_SaveCookie(null, event);
                    break;
                case 114:
                    //F3
                    t2.focus();
                    t2.select();
                    break;
                case 113:
                    //F2
                    t1.focus();
                    t1.select();
                    break;
                case 67:
                    //c
                    function createABlockAndSetPosionByMouse() {
                        showInfoAlphaDown("創造方塊並放在鼠標位置")
                        b = addABlock();
                        console.log(svg1.width.animVal.value);
                        x = svg1.viewBox.animVal.x;
                        y = svg1.viewBox.animVal.y;
                        width = svg1.viewBox.animVal.width;
                        height = svg1.viewBox.animVal.height;
                        r = document.getElementById(b.rectId);
                        p = getMouseOnSvg();
                        r.setAttributeNS(null, 'x', p.x);
                        r.setAttributeNS(null, 'y', p.y);
                        //connect = 0;
                        select_line = null;
                        seletctBlockAndSetTextAreaValueAndSync(b);
                        updateBlock(b);
                        playSound(createAudio);
                        t1_UpdateAndSearchAlone();
                    }
                    createABlockAndSetPosionByMouse();
                    okToBodyKeydown = false;
                    break;
                case 87:
                    //w
                    yMin -= power;
                    break;
                case 83:
                    //s
                    yMin += power;
                    break;
                case 65:
                    //a
                    xMin -= power;
                    break;
                case 68:
                    //d
                    xMin += power;
                    break;
                case 46:
                    //del
                    DeleteBlockAndNeighborLinez();
                    okToBodyKeydown = false;
            }
            viewBox = `${xMin} ${yMin} ${width} ${height}`;
            svg1.setAttribute('viewBox', viewBox)
        }

        function DeleteBlockAndNeighborLinez() {
            if (previous_select_rect != null) {
                select_line = null;
                connect = 0;
                let block = getBlock(previous_select_rect);
                if (block != null) {
                    for (let i = 0; i < block.linezId.length; i++) {
                        let l = document.getElementById(block.linezId[i]);
                        if (l == null) {
                            block.linezId.splice(i, 1);
                            delete ab[l];
                            i--;
                            continue;
                        }
                        svg1.removeChild(l);
                    }
                    console.log(previous_select_rect);
                    svg1.removeChild(document.getElementById(block.textId));
                    svg1.removeChild(document.getElementById(block.rectId));
                    deleteABlock(block);
                    console.log("del");
                    playSound(deletaAudio);
                    showInfoAlphaDown("刪除方塊");
                    previous_select_rect = null;
                    t1_UpdateAndSearchAlone();
                }
            } else if (select_line != null) {
                lineId = select_line;
                deleteALineById(lineId.id);
                showInfoAlphaDown("刪除連線");
                playSound(deletaAudio);
            }
        }

        function deleteALineById(lineId) {
            console.log(lineId);
            let l = document.getElementById(lineId);
            let k = getAB(l);
            b1 = k.aBlock
            for (let i = 0; i < b1.linezId.length; i++) {
                testLineId = b1.linezId[i];
                if (lineId == testLineId) {
                    b1.linezId.splice(i, 1);
                    console.log("delete line id");
                    i--;
                }
            }
            b2 = k.bBlock;
            for (let i = 0; i < b2.linezId.length; i++) {
                testLineId = b2.linezId[i];
                if (lineId == testLineId) {
                    b2.linezId.splice(i, 1);
                    console.log("delete line id");
                    i--;
                }
            }
            delete ab[lineId]
            showInfoAlphaDown("刪除連線");
            svg1.removeChild(l);
            select_line = null;
        }

        function isFocueOnLeft() {
            return document.activeElement == searchText || document.activeElement == t1 || document.activeElement == t2;
        }

        function setDataByData(data) {
            //var data = JSON.parse(text);
            console.log(data);
            flow_id_block = data.flow_id_block;
            flow_id_line = data.flow_id_line;
            div_right.innerHTML = data.innerHTML;
            blockz = data.blockz;
            ab = data.ab;
            //data.blockById = blockById;
            //rebuild blockById
            blockById = data.blockById;
            //blockz = data.blockz;
            blockz = [];
            i = 0;
            $.each(blockById, function(index, value) {
                console.log(value);
                var e = document.getElementById(value.rectId);
                if (e != null) {
                    blockz[i] = value;
                    i++;
                } else {
                    delete blockById[index];
                    console.log("delete null " + value);
                }
            });
            console.log(blockz);
        }

        function onChange(e) {
            file = e.target.files[0];
            file.text().then(a => {
                try {

                    ini();
                    text = a;
                    console.log(text);
                    //console.log(e.target.files[0]);
                    setDataByData(JSON.parse(text));
                    svg1.onmousemove = on_mouse_move;
                    check_blockById();
                    console.log("load completed");
                    if (blockz != null) {

                        showInfoAlphaDown("讀取檔案成功");
                    } else {
                        ini();
                        showInfoAlphaDown("讀取檔案錯誤！初始化畫布。");
                    }
                } catch {
                    ini();
                    showInfoAlphaDown("讀取檔案錯誤！初始化畫布。");
                }
            });
        }

        function save_onclick(button, event) {
            var data = getWholeData();

            str = JSON.stringify(data);
            saveTextAsFile(t3.value + ".txt", str);
            console.log('a')
        }

        function destroyClickedElement(event) {
            document.body.removeChild(event.target);
        }

        function load_onclick(button, event) {

        }

        function svg_onMouseDown(event) {

        }

        function create_onclick(button, event) {
            showInfoAlphaDown("創造方塊並放在視圖中間")

            b = addABlock();

            //connect = 0;
            select_line = null;

            select_rect = document.getElementById(b.rectId);
            seletctBlockAndSetTextAreaValueAndSync(getBlock(select_rect));

            console.log(svg1.width.animVal.value);
            x = svg1.viewBox.animVal.x;
            y = svg1.viewBox.animVal.y;
            width = svg1.viewBox.animVal.width;
            height = svg1.viewBox.animVal.height;

            select_rect.setAttributeNS(null, 'x', width / 2 + x);
            select_rect.setAttributeNS(null, 'y', height / 2 + y);

            playSound(createAudio);
            updateBlock(b);

            previous_select_rect = select_rect;
            select_rect = null;
            t1_UpdateAndSearchAlone();
        }

        function on_mouse_down() {
            select_line = null;
            previous_select_rect = select_rect = select_text = null;

            t2.oninput = t1.oninput = null;
            console.log("a");

            if (event.buttons == 2) {
                if (connect == 0) {
                    showInfoAlphaDown("選取畫布");
                    drag = true;
                }
            }
            if (event.buttons == 1) {
                select_line = null;
                if (connect == 1) {
                    connect = 0;
                    showInfoAlphaDown("取消連線");
                } else {

                }
            }
            //work
        }

        function onMouseUp() {
            drag = false;
        }

        function updateBlock(b) {
            set_text_in_rect(b.textId, b.rectId);
        }

        function deleteABlock(block) {
            delete blockById[block.rectId];
            blockz.splice(blockz.indexOf(block), 1);
        }

        function addABlock() {
            console.log($("#color1").color);
            svg1.innerHTML += `<rect x="100" y="50" z="1" width="40" height="40" stroke="#` + c1[0].value + `" stroke-width="2" fill="#` + c2[0].value + `" onmousedown="mouse_down(event,this);" id="rect` + flow_id_block + `"></rect>
            <text x="100" y="50" z="1" onselectstart="return false;" unselectable id="rect` + flow_id_block + `_text" fill="#` + c3[0].value + `" class="rect1_text" onmousedown="mouse_down(event,rect` + flow_id_block + `);">123</text>`;
            r = document.getElementById(`rect` + flow_id_block);
            t = document.getElementById("rect" + flow_id_block + "_text");
            //console.log(r);
            //console.log(t);
            b = {};
            b.rectId = r.id;
            b.textId = t.id;
            b.linezId = [];
            b.id = r.id;
            b.detail = "";
            console.log(b.id);
            blockz.push(b);
            blockById[r.id] = b;

            //r.setAttributeNS(null, 'block', JSON.stringify(b));
            //console.log(r.block);
            set_text_in_rect(t.id, r.id);
            flow_id_block += 1;
            return b;
        }

        function addALine(x1, y1, x2, y2) {
            svg1.innerHTML = `<line x1="` + x1 + `" y1="` + y1 + `" x2="` + x2 + `" y2="` + y2 + `" z="2" onmousedown="line_click(this,event)" stroke="#` + c4[0].value + `" stroke-width="` + myNumber.value + `px" id="line` + flow_id_line + `"/>` + svg1.innerHTML;
            var l = document.getElementById("line" + flow_id_line);
            flow_id_line += 1;
            ab[l.id] = {};
            return l;
        }
        select_line = null;

        function line_click(line, event) {
            playSound(lineAudio);
            showInfoAlphaDown("選取直線");
            select_line = line;
            previous_select_text = previous_select_rect = select_rect = null;
        }

        /*
        l is line element
        */
        function getAB(l) {
            return ab[l.id];
        }
        //console.log(div_right.offsetLeft);
        function getMouseOnSvg() {
            if (mouse_event == undefined) {
                return {
                    x: 0,
                    y: 0
                };
            }
            let startClient = {
                x: mouse_event.clientX,
                y: mouse_event.clientY
            }
            let newSVGPoint = svg1.createSVGPoint()
            let CTM = svg1.getScreenCTM()
            newSVGPoint.x = startClient.x
            newSVGPoint.y = startClient.y
            let startSVGPoint = newSVGPoint.matrixTransform(CTM.inverse())
            return startSVGPoint;
        }

        function showInfoAlphaDown(newInfo) {
            if (translate != null) {
                newInfo = translate[newInfo];
            }
            $("#info").stop().html(newInfo).css('opacity', 1).animate({
                opacity: '0.2'
            }, "slow")
        }

        function on_mouse_move(event) {
            mouse_event = event;
            //console.log(event);
            //拖拉方塊
            if (select_rect != null && drag && event.buttons == 1) {
                showInfoAlphaDown("拖拉方塊");
                let startViewBox = svg1.getAttribute('viewBox').split(' ').map(n => parseFloat(n))
                let startSVGPoint = getMouseOnSvg();
                x = svg1.viewBox.animVal.x;
                y = svg1.viewBox.animVal.y;
                select_rect = document.getElementById(select_rect.id);
                select_rect.setAttributeNS(null, 'x', startSVGPoint.x + dx)
                select_rect.setAttributeNS(null, 'y', startSVGPoint.y + dy)
                //select_rect.setAttributeNS(null, 'x', event.clientX - div_right.offsetLeft);
                //select_rect.setAttributeNS(null, 'y', event.clientY - div_right.offsetTop);
                set_text_in_rect(select_text.id, select_rect.id);
                b = blockById[select_rect.id];
                //select_rect.block = b;
                if (!b) {
                    console.log("error");
                }
                updateBlockLine(b);
                //console.log("move");
            }
            //移動畫布
            else if (select_rect == null && mouse_event.buttons == 2) {
                if (connect == 0) {
                    showInfoAlphaDown("移動畫布");
                }
                let startViewBox = svg1.getAttribute('viewBox').split(' ').map(n => parseFloat(n))

                //	2. 取得滑鼠當前 viewport 中 client 座標值
                let startClient = {
                    x: event.clientX,
                    y: event.clientY
                }

                //	3. 計算對應回去的 SVG 座標值
                let newSVGPoint = svg1.createSVGPoint()
                let CTM = svg1.getScreenCTM()
                newSVGPoint.x = startClient.x
                newSVGPoint.y = startClient.y
                let startSVGPoint = newSVGPoint.matrixTransform(CTM.inverse())

                //	4. 計算拖曳後滑鼠所在的 viewport client 座標值
                let moveToClient = {
                    x: event.clientX + event.movementX, //	movement 可以取得滑鼠位移量
                    y: event.clientY + event.movementY
                }

                //	5. 計算對應回去的 SVG 座標值
                newSVGPoint = svg1.createSVGPoint()
                CTM = svg1.getScreenCTM()
                newSVGPoint.x = moveToClient.x
                newSVGPoint.y = moveToClient.y
                let moveToSVGPoint = newSVGPoint.matrixTransform(CTM.inverse())

                //	6. 計算位移量
                let delta = {
                    dx: startSVGPoint.x - moveToSVGPoint.x,
                    dy: startSVGPoint.y - moveToSVGPoint.y
                }

                //	7. 設定新的 viewBox 值
                let moveToViewBox = `${startViewBox[0] + delta.dx} ${startViewBox[1] + delta.dy} ${startViewBox[2]} ${startViewBox[3]}`
                svg1.setAttribute('viewBox', moveToViewBox)
                //console.log(moveToViewBox)
            }
            //console.log(select_rect);
        }

        function getMiddle(rect) {
            var p = {};
            p.x = parseFloat(rect.getAttributeNS(null, 'x')) + (parseFloat(rect.getAttributeNS(null, 'width')) / 2);
            p.y = parseFloat(rect.getAttributeNS(null, 'y')) + (parseFloat(rect.getAttributeNS(null, 'height')) / 2);
            return p;
        }

        function updateBlockLine(block) {
            //console.log(block.linez);
            var be = document.getElementById(block.rectId);
            p = getMiddle(be);
            for (let i = 0; i < block.linezId.length; i++) {
                l = document.getElementById(block.linezId[i]);
                //l = document.getElementById(l.id);
                if (l == null) {
                    block.linezId.splice(i, 1);
                    i--;
                    continue;
                }
                var k = getAB(l);
                //console.log(k.aBlock.id);
                //console.log(k.bBlock.id);
                //console.log(block.id);
                if (k.aBlock.id == block.id) {
                    //console.log("a");
                    l.setAttributeNS(null, 'x1', p.x);
                    l.setAttributeNS(null, 'y1', p.y);
                    p2 = getMiddle(document.getElementById(k.bBlock.rectId));
                    l.setAttributeNS(null, 'x2', p2.x);
                    l.setAttributeNS(null, 'y2', p2.y);

                } else if (k.bBlock.id == block.id) {
                    //console.log("b");
                    //console.log("b");
                    l.setAttributeNS(null, 'x2', p.x);
                    l.setAttributeNS(null, 'y2', p.y);
                    p2 = getMiddle(document.getElementById(k.aBlock.rectId));
                    l.setAttributeNS(null, 'x1', p2.x);
                    l.setAttributeNS(null, 'y1', p2.y);
                } else {
                    console.log("err");
                }
                //console.log(p.x);
            }
        }

        function getBlock(r) {
            return blockById[r.id];
            //return JSON.parse(r.getAttributeNS(null, 'block'));
        }

        function mouse_down(event, s) {
            //console.log("c1_click");
            //console.log(event);
            drag = true;
            select_line = null;
            //連線
            if (event.buttons == 2) {
                if (connect == 0) {
                    playSound(lineAudio);
                    showInfoAlphaDown("設定連線起點");
                    connect = 1;
                    connect1_rect = s;
                    //console.log(s.block);
                    connect1_text = et = document.getElementById(s.id + "_text");
                } else if (connect == 1) {
                    playSound(lineAudio);
                    connect = 2;
                    window.setTimeout(() => {
                        connect = 0
                    }, 100);
                    connect2_rect = s;
                    //console.log(s.block);
                    connect2_text = et = document.getElementById(s.id + "_text");
                    p1 = getMiddle(connect1_rect);
                    p2 = getMiddle(connect2_rect);
                    //console.log(p1);
                    b1 = getBlock(connect1_rect);
                    b2 = getBlock(connect2_rect);
                    isExist = false;
                    isSame = false;
                    if (connect1_rect == connect2_rect) {
                        isSame = true;
                    } else {
                        for (let i = 0; i < b1.linezId.length; i++) {
                            lineId = b1.linezId[i];
                            k = ab[lineId];
                            if (k.aBlock == b1 && k.bBlock == b2) {
                                isExist = true;
                                break;
                            } else if (k.aBlock == b2 && k.bBlock == b1) {
                                isExist = true;
                                break;
                            }
                        }
                    }
                    if (isSame) {
                        console.log("no self");
                    } else {
                        if (isExist) {
                            console.log('exist so delete old');
                            //console.log(lineId);
                            deleteALineById(lineId);
                            showInfoAlphaDown("更新連線");

                        } else {
                            showInfoAlphaDown("完成連線");
                        }

                        var l = addALine(p1.x, p1.y, p2.x, p2.y);
                        select_line = l;
                        ab[l.id].aBlock = b1;
                        ab[l.id].bBlock = b2;
                        if (!ab[l.id].aBlock) {
                            console.log("err");
                        }
                        if (!ab[l.id].bBlock) {
                            console.log("err");
                        }
                        b1 = getBlock(connect1_rect);
                        b2 = getBlock(connect2_rect);
                        console.log(b1);
                        console.log(b2);
                        b1.linezId.push(l.id);
                        b2.linezId.push(l.id);

                        console.log('connect');
                    }
                }
            }
            //拖拉方塊開始
            if (event.buttons == 1) {
                if (s.tagName == "text") {
                    s = s.block.rect;
                    console.log("text");
                } else if (s.tagName == "rect") {
                    console.log("rect");
                }
                showInfoAlphaDown("選取方塊");
                select_rect = s;
                select_text = et = document.getElementById(s.id + "_text");
                previous_select_rect = previous_select_text = null;
                select_line = null;
                connect = 0;

                let block = getBlock(select_rect);
                seletctBlockAndSetTextAreaValueAndSync(block);

                let startClient = {
                    x: event.clientX,
                    y: event.clientY
                }
                let newSVGPoint = svg1.createSVGPoint()
                let CTM = svg1.getScreenCTM()
                newSVGPoint.x = startClient.x
                newSVGPoint.y = startClient.y
                let startSVGPoint = newSVGPoint.matrixTransform(CTM.inverse())
                console.log(select_rect.x);
                dx = select_rect.x.animVal.value - startSVGPoint.x;
                dy = select_rect.y.animVal.value - startSVGPoint.y;
                on_mouse_move(event);
            } else {}
            return false;
        }

        function seletctBlockAndSetTextAreaValueAndSync(b) {
            t1_UpdateAndSearchAlone();
            previous_select_rect = document.getElementById(b.rectId);
            previous_select_text = document.getElementById(b.textId);
            select_text = document.getElementById(b.textId);
            et = document.getElementById(b.textId);
            t1.value = et.innerHTML;
            t2.value = b.detail;
            console.log(b.detail);
            //TextChange 
            t1.oninput = function() {
                et.innerHTML = t1.value;
                set_text_in_rect(et.id, b.rectId);
                updateBlockLine(b);
            };
            t1.addEventListener('input', t1_UpdateAndSearchAlone);
            t2.oninput = function() {
                b.detail = t2.value;
            }
        }

        function set_text_in_rect(textId, rId) {
            //console.log(text.x);
            //console.log(text.y);
            text = document.getElementById(textId);
            r1 = document.getElementById(rId);
            //console.log(text);
            size = textSize("20px", "Microsoft JhengHei", escape(text.innerHTML));
            w = size.width + 30;
            if (w == 0) {
                w = 10;
            }
            h = size.height;
            if (h == 0) {
                h = 10;
            }
            r1.setAttributeNS(null, 'width', w);
            r1.setAttributeNS(null, 'hight', h);
            text.setAttributeNS(null, 'x', parseFloat(r1.getAttributeNS(null, 'x')) + parseFloat(r1.getAttributeNS(null, 'width')) / 2);
            text.setAttributeNS(null, 'y', parseFloat(r1.getAttributeNS(null, 'y')) + parseFloat(r1.getAttributeNS(null, 'height')) / 2 + 7);
            //console.log(text.innerHTML.length);
            //console.log(text.y);
        }
        /*
版权声明：本文为CSDN博主「zy1281539626」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/zy1281539626/article/details/78489279
        */

        function textSize(fontSize, fontFamily, text) {
            var span = document.createElement("span");
            var result = {};
            result.width = span.offsetWidth;
            result.height = span.offsetHeight;
            span.style.visibility = "hidden";
            span.style.fontSize = fontSize;
            span.style.fontFamily = fontFamily;
            span.style.display = "inline-block";
            document.body.appendChild(span);
            if (typeof span.textContent != "undefined") {
                span.textContent = text;
            } else {
                span.innerText = text;
            }
            result.width = parseFloat(window.getComputedStyle(span).width) - result.width;
            result.height = parseFloat(window.getComputedStyle(span).height) - result.height;
            document.body.removeChild(span);
            return result;
        }

        function svgToPng(svg, pngWidth, pngHeight) {
            var serializer = new XMLSerializer();
            var source = '<?xml version="1.0" standalone="no"?>\r\n' + serializer.serializeToString(svg.cloneNode(true));
            var image = new Image;
            image.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
            var canvas = document.createElement("canvas");
            canvas.width = pngWidth;
            canvas.height = pngHeight;
            var context = canvas.getContext("2d");
            context.fillStyle = '#fff'; //設定儲存後的PNG 是白色的
            context.fillRect(0, 0, 10000, 10000);
            context.drawImage(image, 0, 0);
            var data = canvas.toDataURL("image/png");

            var a = document.createElement('a');
            a.style = "display:none;";
            a.href = data;
            a.download = 'myAwesomeSVG.png';
            a.innerHTML = 'download the png file';
            a.click();
        }


        function saveTextAsFile(_fileName, _text) {

            var downloadLink = document.createElement("a");
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.href = 'data:text/plain; charset=utf8, ' + encodeURIComponent(_text);
            downloadLink.download = _fileName;
            downloadLink.innerHTML = "Download File";
            downloadLink.click();
            window.URL.revokeObjectURL(downloadLink.href);
            document.body.removeChild(downloadLink);
        }

        function exportSVG(svg) {
            // first create a clone of our svg node so we don't mess the original one
            var clone = svg.cloneNode(true);
            // parse the styles
            parseStyles(clone);

            // create a doctype
            var svgDocType = document.implementation.createDocumentType('svg', "-//W3C//DTD SVG 1.1//EN", "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd");
            // a fresh svg document
            var svgDoc = document.implementation.createDocument('http://www.w3.org/2000/svg', 'svg', svgDocType);
            // replace the documentElement with our clone 
            svgDoc.replaceChild(clone, svgDoc.documentElement);
            // get the data
            var svgData = (new XMLSerializer()).serializeToString(svgDoc);

            // now you've got your svg data, the following will depend on how you want to download it
            // e.g yo could make a Blob of it for FileSaver.js
            /*
            var blob = new Blob([svgData.replace(/></g, '>\n\r<')]);
            saveAs(blob, 'myAwesomeSVG.svg');
            */
            // here I'll just make a simple a with download attribute

            var a = document.createElement('a');
            a.style.display = "none";
            document.body.appendChild(a);
            a.href = 'data:image/svg+xml; charset=utf8, ' + encodeURIComponent(svgData.replace(/></g, '>\n\r<'));
            //location.href = 'data:image/svg+xml; charset=utf8, ' + encodeURIComponent(svgData.replace(/></g, '>\n\r<'));
            //download('data:image/svg+xml; charset=utf8, ' + encodeURIComponent(svgData.replace(/></g, '>\n\r<')), t3.value + '.svg')
            a.download = t3.value + '.svg';
            a.innerHTML = 'download the svg file';
            a.click();
            window.URL.revokeObjectURL(a.href);
            document.body.removeChild(a);
            //document.body.appendChild(a);

        }

        var parseStyles = function(svg) {
            var styleSheets = [];
            var i;
            // get the stylesheets of the document (ownerDocument in case svg is in <iframe> or <object>)
            var docStyles = svg.ownerDocument.styleSheets;

            // transform the live StyleSheetList to an array to avoid endless loop
            for (i = 0; i < docStyles.length; i++) {
                styleSheets.push(docStyles[i]);
            }

            if (!styleSheets.length) {
                return;
            }

            var defs = svg.querySelector('defs') || document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            if (!defs.parentNode) {
                svg.insertBefore(defs, svg.firstElementChild);
            }
            svg.matches = svg.matches || svg.webkitMatchesSelector || svg.mozMatchesSelector || svg.msMatchesSelector || svg.oMatchesSelector;


            // iterate through all document's stylesheets
            for (i = 0; i < styleSheets.length; i++) {
                var currentStyle = styleSheets[i]

                var rules;
                try {
                    rules = currentStyle.cssRules;
                } catch (e) {
                    continue;
                }
                // create a new style element
                var style = document.createElement('style');
                // some stylesheets can't be accessed and will throw a security error
                var l = rules && rules.length;
                // iterate through each cssRules of this stylesheet
                for (var j = 0; j < l; j++) {
                    // get the selector of this cssRules
                    var selector = rules[j].selectorText;
                    // probably an external stylesheet we can't access
                    if (!selector) {
                        continue;
                    }

                    // is it our svg node or one of its children ?
                    if ((svg.matches && svg.matches(selector)) || svg.querySelector(selector)) {

                        var cssText = rules[j].cssText;
                        // append it to our <style> node
                        style.innerHTML += cssText + '\n';
                    }
                }
                // if we got some rules
                if (style.innerHTML) {
                    // append the style node to the clone's defs
                    defs.appendChild(style);
                }
            }

        };

        function escape(s) {
            return s.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/'/g, "&#39;")
                .replace(/"/g, "&quot;");
        }

    </script>
</body>

</html>
