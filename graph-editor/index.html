<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta http-equiv="content-language" content="zh-tw">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script srv="saveSvgAsPng.js"></script>
    <title>圖型編輯器</title>
    <style type="text/css">
        #div_left {
            width: 300px;
            min-height: 90vh;
            background-color: antiquewhite;
            float: left;
        }

        #div_right {
            padding: 0px;
            margin: 0px;
            float: left;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -o-user-select: none;
        }

        #t1 {
            margin: 0px;
            padding: 0px;
            min-width: 200px;
            min-height: 20px;
        }

        #t2 {
            margin: 0px;
            padding: 0px;
            min-width: 200px;
            min-height: 200px;
        }

        #searchText {}

        #svg1 {
            background-color: aquamarine;
            border: 1px double black;
        }

        .rect1_text {
            text-anchor: middle;
            font-size: 20px;
            font-family: 微軟正黑體;
        }

        .box {
            border: 2px dotted gray;
            width: auto;
            max-width: 230px;
            padding: 5px;
            margin: 5px;
        }

        .infoBox {
            max-width: 250px;
            min-width: 250px;
            border-left: 1px dashed black;
            border-right: 1px dashed black;
            text-align: center;
        }

    </style>
</head>

<body onkeydown="body_onkeydown(event);">
    <div id="div_left">
        <audio id="lineAudio" src="sound/18V_Cordless_Drill_Switch.mp3"></audio>
        <audio id="deletaAudio" src="sound/Air_Woosh_Underwater.mp3"></audio>
        <audio id="createAudio" src="sound/Beep_Short.mp3"></audio>
        <div class="box">
            左鍵點擊方塊可以設定名稱與資料，右鍵分別點擊方塊連線，DEL刪除方塊或連線
            <br />
            <br />
            <button onclick="create_onclick(this,event);">create block at center [C]</button>
        </div>
        <div class="box">
            線段粗細(px):<input type="number" id="myNumber" defaultValue="2" value="2" min="1" max="20">
        </div>
        <div class="infoBox">
            <span id="info"></span>
        </div>
        <div class="box">
            搜尋:
            <br />
            <textarea id="searchText" oninput="searchOnInput(this,event);"></textarea>
        </div>
        <div class="box">
            方塊名稱:
            <br />
            <textarea id="t1"></textarea>
            <br />
            方塊資料:
            <textarea id="t2"></textarea>
        </div>
        <div class="box">
            Load File:
            <br />
            <input type="file" id="file1" onchange="onChange(event);">
        </div>
        <div class="box">
            Save Name:
            <br />
            <textarea id="t3">圖形連線</textarea>
            <button onclick="save_onclick(this,event);">save data text</button>
            <button onclick="save2_onclick(this,event);">save viewport .svg</button>
        </div>
        <div class="box">
            <input type="checkbox" checked id="soundCheckBox">音效</input>
        </div>
    </div>
    <div id="div_right" onContextMenu="return false">
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" id="svg1" width="900" height="800" onmousedown="svg_onMouseDown(event)" viewBox="0 0 900 800" onMouseUp="onMouseUp(event);"></svg>
    </div>
    <script>
        ini();

        function ini() {
            previous_select_rect = null;
            drag = false;
            select_rect = null;
            select_text = null;
            connect1_rect = null;
            connect1_text = null;
            connect2_rect = null;
            connect2_text = null;
            select_line = null;
            flow_id_block = 0;
            flow_id_line = 0;
            dx = dy = 0;
            blockz = [];
            blockById = {};
            connect = 0;
            ab = {};
            svg1.onmousemove = on_mouse_move;
        }
        console.log(svg1.viewBox);
        addABlock();
        //addABlock();

        function searchOnInput(search, event) {
            console.log('a');
            s = searchText.value;
            find = false;
            for (let i = 0; i < blockz.length; i++) {
                block = blockz[i];
                var name = document.getElementById(block.textId).innerHTML;
                console.log(name);
                if (name == s) {
                    find = true;
                    break;
                }
            }
            if (find) {
                console.log('find same');
                showInfoAlphaDown("找到完全相同文字的方塊")
                lookAtBlockAndSelctIt(block)
                return;
            }
            for (let i = 0; i < blockz.length; i++) {
                block = blockz[i];
                var name = document.getElementById(block.textId).innerHTML;
                console.log(name);
                if (name.includes(s)) {
                    find = true;
                    break;
                }
            }
            if (find) {
                console.log('find contain');
                showInfoAlphaDown("找到包含文字的方塊")
                lookAtBlockAndSelctIt(block)
                return;
            }
            if (!find) {
                console.log('not find');
                showInfoAlphaDown("在所有方塊中找不到文字")
                return;
            }
        }

        function lookAtBlockAndSelctIt(block) {
            viewBox = svg1.viewBox;
            console.log(viewBox);
            rect = document.getElementById(block.rectId);
            seletctBlockAndSetTextAreaValueAndSync(block);
            console.log(rect.x);
            x = rect.x.animVal.value - svg1.viewBox.animVal.width / 2 + rect.width.animVal.value / 2;
            y = rect.y.animVal.value - svg1.viewBox.animVal.height / 2 + rect.height.animVal.value / 2;
            viewBox = `${x} ${y} ${svg1.viewBox.animVal.width} ${svg1.viewBox.animVal.height}`;
            //rect.setAttributeNS(null, 'x', svg1.viewBox.animVal.x - svg1.viewBox.animVal.width / 2);
            //rect.setAttributeNS(null, 'y', svg1.viewBox.animVal.x - svg1.viewBox.animVal.height / 2);
            svg1.setAttributeNS(null, "viewBox", viewBox);
        }

        check_blockById();

        function check_blockById() {
            for (i = 0; i < blockz.length; i++) {
                var a = document.getElementById(`rect` + i);
                if (a == null) {
                    console.log("null:deleted");
                } else {
                    console.log(blockById[a.id]);
                }
            }
        }

        function playSound(a) {
            if (soundCheckBox.checked) {
                a.currentTime = 0;
                a.play();
            }
        }

        function save2_onclick(button, event) {
            //svgToPng(svg1, 900, 800);
            //console.log(png);
            //console.log(svg1);
            exportSVG(svg1);
            //saveSvgAsPng(svg1, "diagram.png");
        }

        function body_onkeydown(event) {
            if (isFocueOnLeft()) {
                return;
            }
            var power = 10;
            console.log(svg1.viewBox);
            console.log(event.keyCode);

            xMin = svg1.viewBox.animVal.x;
            yMin = svg1.viewBox.animVal.y;
            width = svg1.viewBox.animVal.width;
            height = svg1.viewBox.animVal.height;
            switch (event.keyCode) {
                case 67:
                    //c
                    function createABlockAndSetPosionByMouse() {
                        showInfoAlphaDown("創造方塊並放在鼠標位置")
                        b = addABlock();
                        console.log(svg1.width.animVal.value);
                        x = svg1.viewBox.animVal.x;
                        y = svg1.viewBox.animVal.y;
                        width = svg1.viewBox.animVal.width;
                        height = svg1.viewBox.animVal.height;
                        r = document.getElementById(b.rectId);
                        p = getMouseOnSvg();
                        r.setAttributeNS(null, 'x', p.x);
                        r.setAttributeNS(null, 'y', p.y);
                        connect = 0;
                        select_line = null;
                        seletctBlockAndSetTextAreaValueAndSync(b);
                        updateBlock(b);
                        playSound(createAudio);
                    }
                    createABlockAndSetPosionByMouse();
                    break;
                case 87:
                    //w
                    yMin -= power;
                    break;
                case 83:
                    //s
                    yMin += power;
                    break;
                case 65:
                    //a
                    xMin -= power;
                    break;
                case 68:
                    //d
                    xMin += power;
                    break;
                case 46:
                    //del
                    DeleteBlockAndNeighborLinez();
            }
            viewBox = `${xMin} ${yMin} ${width} ${height}`;
            svg1.setAttribute('viewBox', viewBox)
        }

        function DeleteBlockAndNeighborLinez() {
            if (previous_select_rect != null) {
                select_line = null;
                connect = 0;
                let block = getBlock(previous_select_rect);
                for (let i = 0; i < block.linezId.length; i++) {
                    let l = document.getElementById(block.linezId[i]);
                    if (l == null) {
                        block.linezId.splice(i, 1);
                        delete ab[l];
                        i--;
                        continue;
                    }
                    svg1.removeChild(l);
                }
                svg1.removeChild(document.getElementById(block.textId));
                svg1.removeChild(previous_select_rect);
                console.log("del");
                playSound(deletaAudio);
                blockz.splice(blockz.indexOf(block), 1);
                showInfoAlphaDown("刪除方塊");
                previous_select_rect = null;
            }
            if (select_line != null) {
                line = select_line;
                console.log(line);
                let k = getAB(line);
                b1 = k.aBlock
                for (let i = 0; i < b1.linezId.length; i++) {
                    testLineId = b1.linezId[i];
                    if (line.id == testLineId) {
                        b1.linezId.splice(i, 1);
                        console.log("delete line id");
                        i--;
                    }
                }
                b2 = k.bBlock;
                for (let i = 0; i < b2.linezId.length; i++) {
                    testLineId = b2.linezId[i];
                    if (line.id == testLineId) {
                        b2.linezId.splice(i, 1);
                        console.log("delete line id");
                        i--;
                    }
                }
                playSound(deletaAudio);
                showInfoAlphaDown("刪除連線");
                svg1.removeChild(line);
                select_line = null;
            }
        }

        function isFocueOnLeft() {
            return document.activeElement == searchText || document.activeElement == t1 || document.activeElement == t2;
        }

        function onChange(e) {
            file = e.target.files[0];
            file.text().then(a => {
                ini();
                text = a;
                console.log(text);
                //console.log(e.target.files[0]);
                var data = JSON.parse(text);
                console.log(data);
                flow_id_block = data.flow_id_block;
                flow_id_line = data.flow_id_line;
                blockz = data.blockz;
                ab = data.ab;
                //data.blockById = blockById;
                //rebuild blockById
                blockById = data.blockById;
                blockz = data.blockz;
                div_right.innerHTML = data.innerHTML;
                svg1.onmousemove = on_mouse_move;
                check_blockById();
                console.log("load completed");
            });
        }

        function save_onclick(button, event) {
            var data = {};
            data.flow_id_block = flow_id_block;
            data.flow_id_line = flow_id_line;
            data.ab = ab;
            data.blockById = blockById;
            data.blockz = blockz;
            data.innerHTML = div_right.innerHTML;

            str = JSON.stringify(data);
            saveTextAsFile(t3.value + ".txt", str);
            console.log('a')
        }

        function saveTextAsFile(_fileName, _text) {
            var textFileAsBlob = new Blob([_text], {
                type: 'text/plain'
            });

            var downloadLink = document.createElement("a");
            downloadLink.download = _fileName;
            downloadLink.innerHTML = "Download File";
            if (window.webkitURL != null) {
                // Chrome allows the link to be clicked
                // without actually adding it to the DOM.
                downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
            } else {
                // Firefox requires the link to be added to the DOM
                // before it can be clicked.
                downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
                downloadLink.onclick = destroyClickedElement;
                downloadLink.style.display = "none";
                document.body.appendChild(downloadLink);
            }

            downloadLink.click();
        }

        function destroyClickedElement(event) {
            document.body.removeChild(event.target);
        }

        function load_onclick(button, event) {

        }

        function svg_onMouseDown(event) {
            if (event.button == 2) {
                if (connect == 0) {
                    showInfoAlphaDown("選取畫布");
                    drag = true;
                }
            }

        }

        function create_onclick(button, event) {
            showInfoAlphaDown("創造方塊並放在視圖中間")

            b = addABlock();

            connect = 0;
            select_line = null;

            select_rect = document.getElementById(b.rectId);
            seletctBlockAndSetTextAreaValueAndSync(getBlock(select_rect));

            console.log(svg1.width.animVal.value);
            x = svg1.viewBox.animVal.x;
            y = svg1.viewBox.animVal.y;
            width = svg1.viewBox.animVal.width;
            height = svg1.viewBox.animVal.height;
            r = document.getElementById(b.rectId);
            r.setAttributeNS(null, 'x', width / 2 + x);
            r.setAttributeNS(null, 'y', height / 2 + y);
            playSound(createAudio);
            updateBlock(b);
        }

        function onMouseUp() {
            drag = false;
            previous_select_rect = select_rect;
            select_rect = null;
            select_text = null;
            //console.log("onMouseUp()");
        }

        function updateBlock(b) {
            set_text_in_rect(b.textId, b.rectId);
        }

        function addABlock() {
            svg1.innerHTML += `<rect x="100" y="50" z="1" width="40" height="40" stroke="black" stroke-width="2" fill="red" onmousedown="mouse_down(event,this);" id="rect` + flow_id_block + `"></rect>
            <text x="100" y="50" z="1" onselectstart="return false;" unselectable id="rect` + flow_id_block + `_text" class="rect1_text" onmousedown="mouse_down(event,rect` + flow_id_block + `);">123</text>`;
            r = document.getElementById(`rect` + flow_id_block);
            t = document.getElementById("rect" + flow_id_block + "_text");
            //console.log(r);
            //console.log(t);
            b = {};
            b.rectId = r.id;
            b.textId = t.id;
            b.linezId = [];
            b.id = r.id;
            b.detail = "";
            console.log(b.id);
            blockz.push(b);
            blockById[r.id] = b;

            //r.setAttributeNS(null, 'block', JSON.stringify(b));
            //console.log(r.block);
            set_text_in_rect(t.id, r.id);
            flow_id_block += 1;
            return b;
        }

        function addALine(x1, y1, x2, y2) {
            svg1.innerHTML = `<line x1="` + x1 + `" y1="` + y1 + `" x2="` + x2 + `" y2="` + y2 + `" z="2" onmousedown="line_click(this,event)" style="stroke: Tomato;stroke-width: ` + myNumber.value + `px" id="line` + flow_id_line + `"/>` + svg1.innerHTML;
            var l = document.getElementById("line" + flow_id_line);
            flow_id_line += 1;
            ab[l.id] = {};
            return l;
        }
        select_line = null;

        function line_click(line, event) {
            playSound(lineAudio);
            showInfoAlphaDown("選取直線");
            select_line = line;
        }

        function getAB(l) {
            return ab[l.id];
        }
        //console.log(div_right.offsetLeft);
        function getMouseOnSvg() {
            let startClient = {
                x: mouse_event.clientX,
                y: mouse_event.clientY
            }
            let newSVGPoint = svg1.createSVGPoint()
            let CTM = svg1.getScreenCTM()
            newSVGPoint.x = startClient.x
            newSVGPoint.y = startClient.y
            let startSVGPoint = newSVGPoint.matrixTransform(CTM.inverse())
            return startSVGPoint;
        }

        function showInfoAlphaDown(newInfo) {
            $("#info").stop().html(newInfo).css('opacity', 1).animate({
                opacity: '0.2'
            }, "slow")
        }

        function on_mouse_move(event) {
            mouse_event = event;
            //console.log(event);
            //拖拉方塊
            if (select_rect != null && drag) {
                showInfoAlphaDown("拖拉方塊");
                let startViewBox = svg1.getAttribute('viewBox').split(' ').map(n => parseFloat(n))
                let startSVGPoint = getMouseOnSvg();
                x = svg1.viewBox.animVal.x;
                y = svg1.viewBox.animVal.y;
                select_rect = document.getElementById(select_rect.id);
                select_rect.setAttributeNS(null, 'x', startSVGPoint.x + dx)
                select_rect.setAttributeNS(null, 'y', startSVGPoint.y + dy)
                //select_rect.setAttributeNS(null, 'x', event.clientX - div_right.offsetLeft);
                //select_rect.setAttributeNS(null, 'y', event.clientY - div_right.offsetTop);
                set_text_in_rect(select_text.id, select_rect.id);
                b = blockById[select_rect.id];
                //select_rect.block = b;
                if (!b) {
                    console.log("error");
                }
                updateBlockLine(b);
                //console.log("move");
            }
            //移動畫布
            else if (select_rect == null && drag) {
                if (connect == 0) {
                    showInfoAlphaDown("移動畫布");
                }
                let startViewBox = svg1.getAttribute('viewBox').split(' ').map(n => parseFloat(n))

                //	2. 取得滑鼠當前 viewport 中 client 座標值
                let startClient = {
                    x: event.clientX,
                    y: event.clientY
                }

                //	3. 計算對應回去的 SVG 座標值
                let newSVGPoint = svg1.createSVGPoint()
                let CTM = svg1.getScreenCTM()
                newSVGPoint.x = startClient.x
                newSVGPoint.y = startClient.y
                let startSVGPoint = newSVGPoint.matrixTransform(CTM.inverse())

                //	4. 計算拖曳後滑鼠所在的 viewport client 座標值
                let moveToClient = {
                    x: event.clientX + event.movementX, //	movement 可以取得滑鼠位移量
                    y: event.clientY + event.movementY
                }

                //	5. 計算對應回去的 SVG 座標值
                newSVGPoint = svg1.createSVGPoint()
                CTM = svg1.getScreenCTM()
                newSVGPoint.x = moveToClient.x
                newSVGPoint.y = moveToClient.y
                let moveToSVGPoint = newSVGPoint.matrixTransform(CTM.inverse())

                //	6. 計算位移量
                let delta = {
                    dx: startSVGPoint.x - moveToSVGPoint.x,
                    dy: startSVGPoint.y - moveToSVGPoint.y
                }

                //	7. 設定新的 viewBox 值
                let moveToViewBox = `${startViewBox[0] + delta.dx} ${startViewBox[1] + delta.dy} ${startViewBox[2]} ${startViewBox[3]}`
                svg1.setAttribute('viewBox', moveToViewBox)
                //console.log(moveToViewBox)
            }
            //console.log(select_rect);
        }

        function getMiddle(rect) {
            var p = {};
            p.x = parseFloat(rect.getAttributeNS(null, 'x')) + (parseFloat(rect.getAttributeNS(null, 'width')) / 2);
            p.y = parseFloat(rect.getAttributeNS(null, 'y')) + (parseFloat(rect.getAttributeNS(null, 'height')) / 2);
            return p;
        }

        function updateBlockLine(block) {
            //console.log(block.linez);
            var be = document.getElementById(block.rectId);
            p = getMiddle(be);
            for (let i = 0; i < block.linezId.length; i++) {
                l = document.getElementById(block.linezId[i]);
                //l = document.getElementById(l.id);
                if (l == null) {
                    block.linezId.splice(i, 1);
                    i--;
                    continue;
                }
                var k = getAB(l);
                console.log(k.aBlock.id);
                console.log(k.bBlock.id);
                console.log(block.id);
                if (k.aBlock.id == block.id) {
                    //console.log("a");
                    l.setAttributeNS(null, 'x1', p.x);
                    l.setAttributeNS(null, 'y1', p.y);

                } else if (k.bBlock.id == block.id) {
                    //console.log("b");
                    //console.log("b");
                    l.setAttributeNS(null, 'x2', p.x);
                    l.setAttributeNS(null, 'y2', p.y);
                } else {
                    console.log("err");
                }
                //console.log(p.x);
            }
        }

        function getBlock(r) {
            return blockById[r.id];
            //return JSON.parse(r.getAttributeNS(null, 'block'));
        }

        function mouse_down(event, s) {
            //console.log("c1_click");
            //console.log(event);
            drag = !drag;
            select_line = null;
            //連線
            if (event.button == 2) {
                if (connect == 0) {
                    playSound(lineAudio);
                    showInfoAlphaDown("設定連線起點");
                    connect = 1;
                    connect1_rect = s;
                    //console.log(s.block);
                    connect1_text = et = document.getElementById(s.id + "_text");
                } else if (connect == 1) {
                    playSound(lineAudio);
                    showInfoAlphaDown("完成連線");
                    connect = 2;
                    window.setTimeout(() => {
                        connect = 0
                    }, 100);
                    connect2_rect = s;
                    //console.log(s.block);
                    connect2_text = et = document.getElementById(s.id + "_text");
                    p1 = getMiddle(connect1_rect);
                    p2 = getMiddle(connect2_rect);
                    //console.log(p1);
                    b1 = getBlock(connect1_rect);
                    b2 = getBlock(connect2_rect);
                    isExist = false;
                    isSame = false;
                    if (connect1_rect == connect2_rect) {
                        isSame = true;
                    }
                    for (let i = 0; i < b1.linezId.length; i++) {
                        var k = ab[b1.linezId[i]];
                        if (k.aBlock == b1 && k.bBlock == b2) {
                            isExist = true;
                            break;
                        } else if (k.aBlock == b2 && k.bBlock == b1) {
                            isExist = true;
                            break;
                        }
                    }
                    if (isExist) {
                        console.log('exist');
                    } else if (isSame) {
                        console.log("no self");
                    } else {
                        var l = addALine(p1.x, p1.y, p2.x, p2.y);
                        ab[l.id].aBlock = b1;
                        if (!ab[l.id].aBlock) {
                            console.log("err");
                        }
                        ab[l.id].bBlock = b2;
                        if (!ab[l.id].bBlock) {
                            console.log("err");
                        }
                        //l.a = connect1_rect.block;
                        //l.b = connect2_rect.block;
                        b1 = getBlock(connect1_rect);
                        b2 = getBlock(connect2_rect);
                        console.log(b1);
                        console.log(b2);
                        b1.linezId.push(l.id);
                        b2.linezId.push(l.id);
                        //connect1_rect.block.connectz.push(connect2_rect.block);
                        //connect2_rect.block.connectz.push(connect1_rect.block);

                        console.log('connect');
                    }
                }
            }
            //拖拉方塊開始
            if (drag && event.button == 0) {
                if (s.tagName == "text") {
                    s = s.block.rect;
                    console.log("text");
                } else if (s.tagName == "rect") {
                    console.log("rect");
                }
                showInfoAlphaDown("選取方塊");
                select_rect = s;
                select_text = et = document.getElementById(s.id + "_text");

                let block = getBlock(select_rect);
                seletctBlockAndSetTextAreaValueAndSync(block);

                let startClient = {
                    x: event.clientX,
                    y: event.clientY
                }
                let newSVGPoint = svg1.createSVGPoint()
                let CTM = svg1.getScreenCTM()
                newSVGPoint.x = startClient.x
                newSVGPoint.y = startClient.y
                let startSVGPoint = newSVGPoint.matrixTransform(CTM.inverse())
                console.log(select_rect.x);
                dx = select_rect.x.animVal.value - startSVGPoint.x;
                dy = select_rect.y.animVal.value - startSVGPoint.y;
                on_mouse_move(event);
            } else {}
            return false;
        }

        function seletctBlockAndSetTextAreaValueAndSync(block) {
            previous_select_rect = document.getElementById(block.rectId);
            select_text = document.getElementById(block.textId);
            et = document.getElementById(block.textId);
            t1.value = et.innerHTML;
            t2.value = block.detail;
            console.log(block.detail);
            //TextChange 
            t1.oninput = function() {
                et.innerHTML = t1.value;
                set_text_in_rect(et.id, block.rectId);
                updateBlockLine(block);
            };
            t2.oninput = function() {
                block.detail = t2.value;
            }
        }

        function set_text_in_rect(textId, rId) {
            //console.log(text.x);
            //console.log(text.y);
            text = document.getElementById(textId);
            r1 = document.getElementById(rId);
            size = textSize("20px", "微軟正黑體", escape(text.innerHTML));
            w = size.width + 30;
            if (w == 0) {
                w = 10;
            }
            h = size.height;
            if (h == 0) {
                h = 10;
            }
            r1.setAttributeNS(null, 'width', w);
            r1.setAttributeNS(null, 'hight', h);
            text.setAttributeNS(null, 'x', parseFloat(r1.getAttributeNS(null, 'x')) + parseFloat(r1.getAttributeNS(null, 'width')) / 2);
            text.setAttributeNS(null, 'y', parseFloat(r1.getAttributeNS(null, 'y')) + parseFloat(r1.getAttributeNS(null, 'height')) / 2 + 7);
            //console.log(text.innerHTML.length);
            //console.log(text.y);
        }
        /*
版权声明：本文为CSDN博主「zy1281539626」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/zy1281539626/article/details/78489279
        */

        function textSize(fontSize, fontFamily, text) {
            var span = document.createElement("span");
            var result = {};
            result.width = span.offsetWidth;
            result.height = span.offsetHeight;
            span.style.visibility = "hidden";
            span.style.fontSize = fontSize;
            span.style.fontFamily = fontFamily;
            span.style.display = "inline-block";
            document.body.appendChild(span);
            if (typeof span.textContent != "undefined") {
                span.textContent = text;
            } else {
                span.innerText = text;
            }
            result.width = parseFloat(window.getComputedStyle(span).width) - result.width;
            result.height = parseFloat(window.getComputedStyle(span).height) - result.height;
            document.body.removeChild(span);
            return result;
        }

        function svgToPng(svg, pngWidth, pngHeight) {
            var serializer = new XMLSerializer();
            var source = '<?xml version="1.0" standalone="no"?>\r\n' + serializer.serializeToString(svg.cloneNode(true));
            var image = new Image;
            image.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
            var canvas = document.createElement("canvas");
            canvas.width = pngWidth;
            canvas.height = pngHeight;
            var context = canvas.getContext("2d");
            context.fillStyle = '#fff'; //設定儲存後的PNG 是白色的
            context.fillRect(0, 0, 10000, 10000);
            context.drawImage(image, 0, 0);
            var data = canvas.toDataURL("image/png");

            var a = document.createElement('a');
            a.style = "display:none;";
            a.href = data;
            a.download = 'myAwesomeSVG.png';
            a.innerHTML = 'download the png file';
            a.click();
        }

        function exportSVG(svg) {
            // first create a clone of our svg node so we don't mess the original one
            var clone = svg.cloneNode(true);
            // parse the styles
            parseStyles(clone);

            // create a doctype
            var svgDocType = document.implementation.createDocumentType('svg', "-//W3C//DTD SVG 1.1//EN", "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd");
            // a fresh svg document
            var svgDoc = document.implementation.createDocument('http://www.w3.org/2000/svg', 'svg', svgDocType);
            // replace the documentElement with our clone 
            svgDoc.replaceChild(clone, svgDoc.documentElement);
            // get the data
            var svgData = (new XMLSerializer()).serializeToString(svgDoc);

            // now you've got your svg data, the following will depend on how you want to download it
            // e.g yo could make a Blob of it for FileSaver.js
            /*
            var blob = new Blob([svgData.replace(/></g, '>\n\r<')]);
            saveAs(blob, 'myAwesomeSVG.svg');
            */
            // here I'll just make a simple a with download attribute

            var a = document.createElement('a');
            a.style = "display:none;";
            a.href = 'data:image/svg+xml; charset=utf8, ' + encodeURIComponent(svgData.replace(/></g, '>\n\r<'));
            a.download = t3.value + '.svg';
            a.innerHTML = 'download the svg file';
            a.click();
            //document.body.appendChild(a);

        }

        var parseStyles = function(svg) {
            var styleSheets = [];
            var i;
            // get the stylesheets of the document (ownerDocument in case svg is in <iframe> or <object>)
            var docStyles = svg.ownerDocument.styleSheets;

            // transform the live StyleSheetList to an array to avoid endless loop
            for (i = 0; i < docStyles.length; i++) {
                styleSheets.push(docStyles[i]);
            }

            if (!styleSheets.length) {
                return;
            }

            var defs = svg.querySelector('defs') || document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            if (!defs.parentNode) {
                svg.insertBefore(defs, svg.firstElementChild);
            }
            svg.matches = svg.matches || svg.webkitMatchesSelector || svg.mozMatchesSelector || svg.msMatchesSelector || svg.oMatchesSelector;


            // iterate through all document's stylesheets
            for (i = 0; i < styleSheets.length; i++) {
                var currentStyle = styleSheets[i]

                var rules;
                try {
                    rules = currentStyle.cssRules;
                } catch (e) {
                    continue;
                }
                // create a new style element
                var style = document.createElement('style');
                // some stylesheets can't be accessed and will throw a security error
                var l = rules && rules.length;
                // iterate through each cssRules of this stylesheet
                for (var j = 0; j < l; j++) {
                    // get the selector of this cssRules
                    var selector = rules[j].selectorText;
                    // probably an external stylesheet we can't access
                    if (!selector) {
                        continue;
                    }

                    // is it our svg node or one of its children ?
                    if ((svg.matches && svg.matches(selector)) || svg.querySelector(selector)) {

                        var cssText = rules[j].cssText;
                        // append it to our <style> node
                        style.innerHTML += cssText + '\n';
                    }
                }
                // if we got some rules
                if (style.innerHTML) {
                    // append the style node to the clone's defs
                    defs.appendChild(style);
                }
            }

        };

        function escape(s) {
            return s.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/'/g, "&#39;")
                .replace(/"/g, "&quot;");
        }

    </script>
</body>

</html>
