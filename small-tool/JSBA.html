<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta http-equiv="content-language" content="zh-tw">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script src="leaflet/leaflet.js"></script>
    <link rel="icon" href="JSBA.ico" type="image/x-icon" />
    <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8515898985858287"
        crossorigin="anonymous">
        </script> -->
    <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8515898985858287"
        crossorigin="anonymous"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="esri-leaflet-v3.0.3/esri-leaflet.js"></script>
    <!-- Esri Leaflet Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder/dist/esri-leaflet-geocoder.css" />
    <script src="https://unpkg.com/esri-leaflet-geocoder"></script>
    <title>JSBA簡訊報案</title>
    <style>
        body {
            font-size: 20px;
        }

        #map {
            max-width: 100%;
            width: 412px;
            height: 230px;
        }

        button {
            align-items: center;
            background-image: linear-gradient(#464d55, #25292e);
            border-radius: 8px;
            border-width: 0;
            box-shadow: 0 10px 20px rgba(0, 0, 0, .1), 0 3px 6px rgba(0, 0, 0, .05);
            box-sizing: border-box;
            color: #fff;
            cursor: pointer;
            font-family: expo-brand-demi, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            font-size: 20px;
            justify-content: center;
            margin: 3px;
            outline: none;
            padding: 10px 10px;
            text-align: center;
            text-decoration: none;
        }

        button:hover {
            box-shadow: rgba(0, 1, 0, .2) 0 2px 8px;
            opacity: .85;
        }

        button:active {
            outline: 0;
        }

        @media (max-width: 420px) {
            button {
                height: 48px;
            }
        }

        select {
            font-size: 20px;
            display: inline;
            margin: 3px;
            margin-left: -6px;
            background-color: rgb(168, 153, 153);
            color: white;
            padding: 5px;
            border-radius: 10px;
        }

        .c1 {
            border: 3px solid rgb(155, 155, 155);
            margin: 5px;
            display: block;
            width: fit-content;
            padding: 7px;
            max-width: 100%;
            white-space: nowrap;
            box-shadow: 3px 3px 6px gray;
        }

        .c2 {
            display: block;
        }

        textarea {
            margin: 3px;
            font-size: 20px;
            display: block;
            min-width: 90%;
            min-height: 100px;
            border: 1px solid black;
        }

        .small1 {
            font-size: 18px;
        }

        #mapid {
            max-width: 100%;
            width: 412px;
            height: 230px;
        }

        .c1_2 {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        pre {
            white-space: pre-wrap;
            visibility: hidden;
        }
    </style>
</head>

<body>
    <div class="c2">
        <div title="請使用行動裝置使用本網頁 可以將本網頁加入至主畫面（請GOOGLE）" class="small1">版本：0.1.4(目前公測中)</div>
        <div id="mapid"></div>
        <!-- <div id="map"></div> -->
        <button onclick="setMyPosition()">取得當前地點</button>
        <select id="city" onchange="updatePhoneNumber()">
        </select>
        <select id="type" onchange="updateULan()">
        </select>
        <br>
        <div class="c1">電話：<span id="phoneText">預覽</span>
        </div>
        <div class="c1">簡訊訊息：<textarea id="uLan">預覽</textarea>
            <span class="small1">警語：建議大家根據現場地址與違規事實修改</span>
        </div>
        <button id="sendJienG" onclick="toSendJienG()">輸出到簡訊</button>
        <a href="https://forms.gle/afD5ttmfuaasp5V96">問題回報</a>
        <a href="https://forms.gle/ZgoWFitRa4hTxyJ36">我有建議</a>
        <p class="small1">請使用行動裝置使用本網頁 可以將本網頁加入至主畫面（請GOOGLE）；若請求資料太久（正常在3秒以內）應該是程式壞掉。</p>
        <div id="debug2"></div>
        <pre id="debug1" type="hidden">臺北市 02-2331-8898 0911-510-914
新北市 02-2966-8310 0912-095-110
臺中市 04-2327-8656 0911-510-915
臺南市 06-637-0705 0911-510-916
高雄市 07-251-8241 0911-510-917
桃園市 03-332-2110 0917-110-880
基隆市 02-2424-8884 0911-510-918
新竹市 03-525-1966 0911-510-919
嘉義市 05-222-0693 0911-510-920
新竹縣 03-5513529 0911-510-921
苗栗縣 037-326390 0911-510-922
彰化縣 04-761-9882 0911-510-933
南投縣 049-223-7295 0911-510-923
雲林縣 05-533-0800 0911-510-924
嘉義縣 05-362-0239 0911-510-925
屏東縣 08-732-6239 0911-510-926
宜蘭縣 03-935-6382 0911-510-927
花蓮縣 03-823-0837 0911-510-928
臺東縣 089-330-749 0911-510-929
澎湖縣 06-927-8353 0911-510-930
金門縣 082-328-872 0911-510-931
連江縣 0836-22-489 0911-510-932</pre>
    </div>
    </div>

    <script>
        try {
            var Jawg_Matrix = null
            var geocodeService = null
            let mymap = null
            var marker = null
            let address_components
            var data = debug1.innerHTML
            debug1.innerHTML = "單位,手機簡訊報案號碼\n"
            data = data.replace(/\s\s+/g, ' ');
            //console.log(data)
            var dataArr = data.split(/\n/)
            //console.log(dataArr)
            var data2 = []
            for (let i = 0; i < dataArr.length; i++) {
                //use 0 2
                var d = dataArr[i].split(/ /)
                data2.push(d)
                //console.log(i)
                debug1.innerHTML += d[0] + "," + d[2] + "\n"
                var varItem = new Option(d[0], d[2]);
                city.options.add(varItem);
            }
            //console.log(data2)
            var data3 = '違規臨時停車-違規停車-違規併排停車-佔用身障車格'
            //console.log(data3)
            var dataArr2 = data3.split(/-/g)
            for (let i = 0; i < dataArr2.length; i++) {
                //use 0 2
                var d = dataArr2[i].split(/ /)
                var varItem = new Option(d[0], d[2]);
                type.options.add(varItem);
            }
            function updatePByMarker() {
                uLan.innerHTML = phoneText.innerHTML = "請求資料中..."
                geocodeService.reverse().latlng(marker.getLatLng()).run(function (error, result) {
                    if (error) {
                        phoneText.innerHTML = ""
                        uLan.innerHTML = "發生錯誤，無法取得地址"
                        return;
                    }
                    console.log(result)
                    reverseData = result
                    let cityName = ""
                    cityName = reverseData.address.Region.replace("台", "臺")
                    console.log(cityName)
                    city.text = cityName
                    for (let i = 0; i < city.options.length; i++) {
                        const element = city.options[i];
                        //console.log(element)
                        if (cityName.indexOf(element.text) == 0) {
                            element.setAttribute("selected", true)
                            city.selectedIndex = i
                        } else {
                            element.removeAttribute("selected")
                        }
                    }
                    updateULan()
                    updatePhoneNumber()
                });
            }
            function initFunc() {
                if (geocodeService == null) {
                    geocodeService = L.esri.Geocoding.geocodeService({
                        apikey: "AAPKe6230472dd7c480eb9ea40439c861616Lfu1YA-pPX_sstZmW4pIb8wNBMAVXMLB4dyjLqZjlGPgBv9U6KOuE5NtbBYbcy9J" // replace with your api key - https://developers.arcgis.com
                    });
                }
                if (mymap == null) {
                    mymap = L.map('mapid').setView([pos.lat, pos.lng], 18);
                }
                if (Jawg_Matrix == null) {
                    Jawg_Matrix = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'openstreetmap',
                        minZoom: 0,
                        maxZoom: 22,
                        id: 'lairool2001',
                        accessToken: 'El0nZ6o3VfuZbt9p9pZznJzhUyCowUgTV0Aksp3p92gmlJBK4EFBaXKteTUgCYug'
                    }).addTo(mymap);
                }
                if (marker == null) {
                    marker = L.marker([pos.lat, pos.lng], { draggable: true }).addTo(mymap);
                    marker.addEventListener("dragend", (e) => {
                        console.log(e)
                        updatePByMarker()
                    })
                }
            }
            let reverseData
            //alert("確認使用者互動")
            if (navigator.geolocation) {
                uLan.innerHTML = phoneText.innerHTML = "請求資料中..."
                navigator.geolocation.getCurrentPosition(function (position) {
                    pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    initFunc();
                    updatePByMarker()
                }, getCurrentPositionError);
            }
            function getCurrentPositionError() {
                uLan.innerHTML = "無法取得座標orz(允許本程式權限即可使用)"
                //debug2.innerHTML = "無法取得座標orz(允許本程式權限即可使用)"
                //uLan.innerHTML = ""
                phoneText.innerHTML = "";
            }
            function updateULan() {

                let address = ""
                let previous = ""
                // for (let i = address_components.length - 1; i >= 0; i--) {
                //     let c = address_components[i]
                //     let types = c.types
                //     for (let j = 0; j < types.length; j++) {
                //         const type = types[j];
                //         if (type == "country" || type == "political" || type == "administrative_area_level_1" || type == "postal_code") {
                //             continue
                //         }
                //         else if (previous == c.long_name) {
                //             continue
                //         }
                //         address += c.long_name
                //         previous = c.long_name
                //     }
                // }
                //address = reverseData.address.City + reverseData.address.Neighborhood + reverseData.address.Address + reverseData.address.PlaceName
                address = reverseData.address.City + reverseData.address.Neighborhood + reverseData.address.Address

                if (reverseData.address.Type == "Ocean" || address == "") {
                    uLan.innerHTML = "海上或不在簡訊報案範圍內"
                    phoneText.innerHTML = ""
                    sendJienG.style.display = "none"
                } else {
                    uLan.innerHTML = address + "，" + type.value
                    if (uLan.innerHTML.indexOf("台灣") == 0) {
                        console.log(uLan.innerHTML)
                        uLan.innerHTML = uLan.innerHTML.substring(2)
                        console.log(uLan.innerHTML)
                    }
                    for (let i = 0; i < data2.length; i++) {
                        if (uLan.innerHTML.indexOf(data2[i][0]) == 0) {
                            console.log(uLan.innerHTML)
                            uLan.innerHTML = uLan.innerHTML.substring(data2[2][0].length)
                            console.log(uLan.innerHTML)
                        }
                    }
                    sendJienG.style.display = "block"
                }
            }
            function updatePhoneNumber() {
                if (sendJienG.style.display == "block") {
                    phoneText.innerHTML = city.value;
                }
            }
            function toSendJienG() {
                var elementA = document.createElement("a")
                document.body.appendChild(elementA)
                elementA.setAttribute("href", "sms:" + phoneText.innerHTML + "?body=" + uLan.innerHTML)
                elementA.click()
                document.body.removeChild(elementA)
            }
            function geocodeLatLng(geocoder, map, infowindow, latlng) {
                //console.log(latlng)
                if (latlng == null) {
                    if (marker != null) {
                        latlng = marker.position
                    } else {
                        return
                    }
                }
                geocoder
                    .geocode({ location: latlng })
                    .then((response) => {
                        if (response.results[0]) {
                            //map.setZoom(18);

                            /*const marker = new google.maps.Marker({
                                position: latlng,
                                map: map,
                            });*/

                            //infowindow.setContent(response.results[0].formatted_address);
                            address_components = response.results[0].address_components
                            let cityName = ""
                            for (let i = address_components.length - 1; i >= 0; i--) {
                                let c = address_components[i]
                                console.log(c)
                                let types = c.types
                                for (let j = 0; j < types.length; j++) {
                                    const type = types[j];
                                    if (type.includes("administrative_area_level_1")) {
                                        cityName = c.long_name.replace(/台/, "臺");
                                        break
                                    }
                                }
                            }
                            //city.setAttribute("value", cityName)
                            console.log(cityName)
                            city.text = cityName
                            for (let i = 0; i < city.options.length; i++) {
                                const element = city.options[i];
                                //console.log(element)
                                if (cityName.indexOf(element.text) == 0) {
                                    element.setAttribute("selected", "")
                                } else {
                                    element.removeAttribute("selected")
                                }
                            }
                            updatePhoneNumber()
                            updateULan()
                            //infowindow.open(map, marker);
                        } else {
                            window.alert("No results found");
                        }
                    })
                    .catch((e) => {
                        console.log("Geocoder failed due to: " + e)
                    })
            }
            function setMyPosition() {
                if (navigator.geolocation) {
                    initFunc()
                    navigator.geolocation.getCurrentPosition(function (position) {
                        var pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        marker.setLatLng(pos)
                        mymap.panTo(pos, { amimate: true, duration: 0.3 })
                        updatePByMarker()
                        /*
                        if (marker == null) {
                            marker = new google.maps.Marker({
                                position: pos,
                                map: map,
                                draggable: true
                            });
                            google.maps.event.addListener(marker, 'dragend', function () {
                                if (geocoder && map && infowindow && marker.position) {
                                    console.log("good")
                                } else {
                                    console.log("bad")
                                }
                                geocodeLatLng(geocoder, map, infowindow, null)
                            });
                        } else {
                            marker.setPosition(pos)

                        }
                        console.log(marker.position)

                        map.setZoom(18);
                        map.setCenter(pos);
                        geocodeLatLng(geocoder, map, infowindow, null)
                        console.log(map)*/
                    }, getCurrentPositionError);
                } else {
                    // Browser doesn't support Geolocation
                    alert("未允許或遭遇錯誤！");
                }
            }
            function initMap() {
                geocoder = new google.maps.Geocoder();
                infowindow = new google.maps.InfoWindow();
                var latlng = { lat: 25.046891, lng: 121.516602 }; // 給一個初始位置
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 18, //放大的倍率
                    center: latlng //初始化的地圖中心位置
                });
                setMyPosition()
            } //init_end
        } catch (ex) {
            debug2.innerHTML = ex
        }

    </script>
    <!-- <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbECm-GPCSPm9rhuZ4RSzSe8XVru3uN9Y&callback=initMap">
        </script> -->
</body>

</html>